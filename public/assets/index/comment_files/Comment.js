define(["gsRootView","cMemberService","gsAppAgent","gsRouterRedirect","gsNextPage","gsShowImages","gsTravelsCommentModel","gsRealName"],function(e,t,i,a,n,o,r,s){return e.extend({pageid:10320607123,hpageid:10320607117,param:{goBack:!0,Editing:!1,isLoading:!1,pageIndex:2,pageNum:20,isReply:!1},travelsId:Lizard.P("travelsId")?Lizard.P("travelsId").replace(/[^0-9]/gi,""):0,events:{"click .js_reply":"addReply","click .js_user":"toUserHome","click .img_comment":"toDetailImage","click .js_close":"toClose"},onCreate:function(){this.listElem=this.$el.find(".js_list"),this.listTmpl=_.template(Lizard.T("listTmpl"))},onAppear:function(){Lizard.hideLoading()},onShow:function(){!t.isLogin()&&i.isWeixinBrowser()&&this.weixinAuth(!1),$("body").addClass("white-bg");var e=this;if(e.currentUrl=encodeURIComponent(window.location.href),e.TotalCount=e.datas.TotalCount||0,e.param.Editing=e.datas.Editing,e.setHeader(),e.param.Editing){if(!t.isLogin())return!t.isLogin()&&i.isWeixinBrowser()?void this.weixinAuth(!0):void t.memberLogin({param:"from="+encodeURIComponent(window.location.href),callback:function(){t.isLogin()||($(".js_comments").show(),$("#comment_content").hide())}})}else e.bindNextPage()},setHeader:function(e){var t=this;this._gs_super({back:{tagname:"back",callback:function(){t.param.goBack?a.toBack():t.fetchData(!0)}},center:{tagname:"title",value:t.param.Editing?"添加评论":"评论"},right:function(){return t.param.Editing?[{tagname:"postComment",value:"发表",color:t.isHybrid&&i.compareAppVersion("7.6")<1?"#333333":"",highlightColor:t.isHybrid&&i.compareAppVersion("7.6")<1?"#333333":"",callback:function(){t.postComment(e)}}]:[]}()}),t.header.show()},fetchData:function(e){var t=this;t.param.isLoading||(t.param.isLoading=!0,e?t.param.pageIndex=1:$(".js_list").after(travelsFn.loadingTmpl()),r.GetReplyList.param={Id:t.travelsId,PageIndex:t.param.pageIndex,PageSize:t.param.pageNum},r.GetReplyList.excute(function(i){n.pageIndex=t.param.pageIndex,t.param.pageIndex=t.param.pageIndex+1,t.TotalCount=i.TotalCount,t.commonHandler(e),i.Result&&i.Result.length>0&&t.listElem.append(t.listTmpl({List:i.Result}))},function(i){t.TotalCount=0,t.commonHandler(e),Lizard.showToast("发生了一些错误，请尝试刷新页面：（")}))},commonHandler:function(e){var t=this;t.param.isLoading=!1,$(".loading_bottom_box").remove(),e&&(t.TotalCount<=0&&a.toBack(),n.pageTotal=t.TotalCount,t.param.Editing=!1,t.param.goBack=!0,t.setHeader(),$(".js_list").empty(),$("#comment_content").hide(),$(".js_comments").show(),t.bindNextPage())},bindNextPage:function(){var e=this,t={listId:".js_list",content:".main_box",windowHeight:$(".pb").height()-$(".menu-bottom").height(),pager:{pageIndex:e.param.pageIndex,pageNum:e.param.pageNum,totalCount:e.TotalCount},renderNextPage:function(){e.fetchData()}};e.TotalCount>0&&n.bindScrollEvent(t)},postComment:function(e){if(!t.isLogin())return!t.isLogin()&&i.isWeixinBrowser()?void this.weixinAuth(!0):void t.memberLogin({param:"from="+encodeURIComponent(window.location.href)});var a=this;Lizard.showLoading(),$("#comment_content").blur();var n=$("#comment_content").val();if(!a.isNull(n))return Lizard.hideLoading(),Lizard.showToast({datamodel:{content:"评论不能为空或格式不对！"},hideSec:2e3}),!1;s.checkRealName({successCallback:function(){r.PostAddData.param={TravelId:a.travelsId,Content:n,ReplyIds:e||"",RefImageId:!a.param.isReply&&Lizard.P("id")?Lizard.P("id"):""},r.PostAddData.excute(function(e){a.param.isReply=!1,Lizard.hideLoading();return Lizard.showToast({datamodel:{content:"评论成功！"},maskToHide:!1,hideSec:2e3,onHide:function(){a.fetchData(!0)}}),!1},function(){a.param.isReply=!1,Lizard.hideLoading();Lizard.showToast({datamodel:{content:"网络不给力,请重试"},hideSec:2e3})})},failCallback:function(){Lizard.showToast("您还没有实名认证，不能发表评论哦~")},from:encodeURIComponent(window.location.href)})},isNull:function(e){return""!=this.trim(e)},trim:function(e){return e=e||"",e.replace(/(^\s*)|(\s*$)/g,"")},addReply:function(e){if(!t.isLogin())return!t.isLogin()&&i.isWeixinBrowser()?void this.weixinAuth(!0):void t.memberLogin({param:"from="+encodeURIComponent(window.location.href)});var n=this,o=a.getTarget(e,{elem:"div"}),r=o.data("name")||"楼主",s=o.data("id"),d=$(e.currentTarget).data("type");n.param.isReply=!0,n.param.goBack=!1,n.param.Editing=!0,n.setHeader(s),$("#comment_content").val(""),$("#comment_content").attr("placeholder","add"==d?"添加评论":"回复 "+r+"："),$("#comment_content").show(),$(".js_comments").hide(),$("#comment_content").focus()},toUserHome:function(e){var t,n=$(e.currentTarget),o=n.data("auth")||"";o&&(Lizard.isHybrid||Lizard.isInCtripApp?a.toJump({url:["","destination/user/index.html#/?clientAuth="+o],targetModel:4}):i.isGsHybrid()?(t="ctripgs://wireless/guestUserInfo?clientAuth="+o,a.toJump({url:[t],targetModel:1})):(t="/webapp/you/user?clientAuth="+o+"&from="+encodeURIComponent(window.location.href),a.toJump({url:[t],targetModel:2,host:!0})))},toDetailImage:function(e){var t=e.currentTarget,a=$(t),n=a.index($(t)),r=[];a.each(function(){var e={},t=$(this).attr("src");i.isHybrid()||i.isGsHybrid()?e.url=encodeURIComponent(t):e.src=t,r.push(e)});a.length;if(i.isHybrid())window.CtripUtil.app_open_url("ctrip://wireless/destination/toPreviewImage?index="+n+"&list="+encodeURIComponent(JSON.stringify(r)),1);else if(i.isGsHybrid())gsRouterRedirect.toJump({url:["ctripgs://wireless/ImageDisplay?index="+n+"&list="+encodeURIComponent(JSON.stringify(r))],targetModel:3});else{var s=[];a.each(function(){var e=$(this).attr("src");s.push(e)}),o.init({imgsUrl:s,detail:"",currentImg:n})}},toClose:function(e){$(".appue_scale").css({display:"none"}),$(".appue_scale ul").html("")},weixinAuth:function(e){var t=window.location.href.match(/\&code\=.*\&/g)&&window.location.href.match(/\&code\=.*\&/g)[0].replace("&code=","").replace("&","");if(t){var i="https://youapi.ctrip.com/openapi/Home/WeiAuthGetOpenID?siteno=1&code="+t;$.ajax({type:"get",url:i,dataType:"jsonp",success:function(e){e&&e.openid&&travelsFn.wechatLogin(e.openid,location.href)},error:function(){}})}else if(e){var a=encodeURIComponent(location.href),n="https://youapi.ctrip.com/openapi/Home/WeiAuthBase?siteno=1&state=STATE&returnurl="+a;window.location.href=n}}})});